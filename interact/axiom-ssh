#!/bin/bash

AXIOM_PATH="$HOME/.axiom"
source "$AXIOM_PATH/interact/includes/vars.sh"
source "$AXIOM_PATH/interact/includes/functions.sh"

use_tmux=false
use_mosh=false
use_clipboard_sync=false
connected=false

for var in "$@"
do
    if [ $var == "--tmux" ]
    then
        use_tmux=true
    elif [  $var == "--mosh" ]
	then
		use_mosh=true
    elif [ $var == "--clipboard-sync" ] 
    then
        use_clipboard_sync=true
	fi
done


if [ $use_clipboard_sync == true ]
then
    SSH_TUNNEL='-R 2489:127.0.0.1:2489'
    start_lemonade_server
fi


instance=""

if [ -z "$1" ] || [ "$1" == "--tmux" ] || [ "$1" == "--mosh" ]
then
    instance=$(instance_menu)
else
	instance="$1"
fi

ip=$(instance_ip "$instance")

if [ $use_tmux == true ]
then
	connected=true
	ssh -p2266 op@$ip -t 'tmux new-session -t main' ${SSH_TUNNEL}
fi

if [ $use_mosh == true ]
then
	connected=true
	mosh --ssh='ssh -p2266' op@$ip
fi

if [ $connected == false ]
then
	ssh -p2266 op@$ip ${SSH_TUNNEL}
fi

"$AXIOM_PATH/interact/header.sh"
